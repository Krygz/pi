<!DOCTYPE html>
<html lang="pt-BR" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Orçamentos</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body {
            background-color: #f8f9fa;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        }
        .simple-header {
            background: white;
            border-bottom: 1px solid #dee2e6;
            padding: 1rem 0;
        }
        .simple-card {
            border: 1px solid #e9ecef;
            border-radius: 8px;
            background: white;
        }
        .btn-minimal {
            border-radius: 6px;
            font-weight: 500;
        }
    </style>
</head>
<body>
    <!-- Header Simples -->
    <div class="simple-header">
        <div class="container">
            <div class="d-flex justify-content-between align-items-center">
                <h4 class="mb-0">Orçamentos</h4>
                <div>
                    <a href="/usuarios" class="btn btn-outline-secondary btn-minimal me-2">Usuários</a>
                    <a href="/clientes" class="btn btn-outline-secondary btn-minimal me-2">Clientes</a>
                    <a href="/orcamentos/database" class="btn btn-outline-info btn-minimal me-2">Banco</a>
                    <button type="button" class="btn btn-primary btn-minimal" data-bs-toggle="modal" data-bs-target="#addModal">
                        Novo Orçamento
                    </button>
                </div>
            </div>
        </div>
    </div>

    <div class="container mt-4">
        <!-- Mensagem de Erro -->
        <div th:if="${errorMessage}" class="alert alert-danger" role="alert">
            <span th:text="${errorMessage}">Erro</span>
        </div>

        <!-- Lista -->
        <div class="row">
            <div th:if="${orcamentos == null or orcamentos.empty}" class="col-12">
                <div class="text-center py-5">
                    <p class="text-muted">Nenhum orçamento cadastrado</p>
                </div>
            </div>
            <div th:if="${orcamentos != null and !orcamentos.empty}" th:each="orcamento : ${orcamentos}" class="col-12 col-md-6 col-lg-4 mb-3">
                <div class="simple-card p-3">
                    <div class="d-flex justify-content-between align-items-start mb-2">
                        <div>
                            <h6 class="mb-0" th:if="${orcamento.cliente != null}" th:text="'Cliente: ' + ${orcamento.cliente.nome}">Cliente</h6>
                            <h6 class="mb-0" th:if="${orcamento.usuario != null}" th:text="'Usuário: ' + ${orcamento.usuario.nomeUsuario}">Usuário</h6>
                        </div>
                        <small class="text-muted" th:text="${orcamento.icmsEstados}">Estado</small>
                    </div>
                    <div class="mb-2">
                        <strong>R$ <span th:text="${#numbers.formatDecimal(orcamento.valorOrcamento, 1, 2)}">0,00</span></strong>
                    </div>
                    <div class="text-muted small mb-2">
                        ICMS: R$ <span th:text="${#numbers.formatDecimal(orcamento.valorICMS, 1, 2)}">0,00</span>
                    </div>
                    <div class="d-flex gap-1">
                        <button class="btn btn-sm btn-outline-primary" th:onclick="'editar(' + ${orcamento.id} + ')'">Editar</button>
                        <button class="btn btn-sm btn-outline-danger" th:onclick="'excluir(' + ${orcamento.id} + ')'">Excluir</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal -->
    <div class="modal fade" id="addModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Novo Orçamento</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                
                <form th:action="@{/orcamentos}" th:object="${newOrcamento}" method="post">
                    <div class="modal-body">
                        <!-- Cliente -->
                        <div class="mb-3">
                            <label class="form-label">Cliente (Nome ou CPF)</label>
                            <div class="input-group">
                                <input type="text" id="searchClienteTerm" class="form-control" placeholder="Digite nome ou CPF do cliente">
                                <button type="button" id="searchClienteBtn" class="btn btn-outline-secondary">Buscar</button>
                            </div>
                            <div id="clienteResults" class="mt-2"></div>
                            <div id="clienteSelected" class="mt-2"></div>
                            <input type="hidden" id="clienteId" name="idCliente" />
                        </div>

                        <!-- Usuário (opcional) -->
                        <div class="mb-3">
                            <label class="form-label">Usuário (opcional)</label>
                            <div class="input-group">
                                <input type="text" id="searchTerm" class="form-control" placeholder="Nome do usuário">
                                <button type="button" id="searchBtn" class="btn btn-outline-secondary">Buscar</button>
                            </div>
                            <div id="results" class="mt-2"></div>
                            <div id="selected" class="mt-2"></div>
                            <input type="hidden" id="userId" name="idUsuario" />
                        </div>

                        <!-- Valor -->
                        <div class="mb-3">
                            <label class="form-label">Valor</label>
                            <input type="number" th:field="*{valorOrcamento}" class="form-control" step="0.01" min="0" required>
                        </div>

                        <!-- Estado -->
                        <div class="mb-3">
                            <label class="form-label">Estado</label>
                            <select th:field="*{icmsEstados}" class="form-control" required>
                                <option value="">Selecione</option>
                                <option value="ICMS_MG">MG</option>
                                <option value="ICMS_SP">SP</option>
                                <option value="ICMS_RJ">RJ</option>
                            </select>
                        </div>

                        <!-- Preview -->
                        <div class="alert alert-light" id="preview" style="display: none;">
                            <div id="previewContent"></div>
                        </div>
                    </div>

                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                        <button type="submit" class="btn btn-primary" id="submitBtn" disabled>Salvar</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
    <script>
        $(document).ready(function() {
            // Buscar usuários
            $('#searchBtn').click(function() {
                var term = $('#searchTerm').val().trim();
                if (term.length < 2) {
                    alert('Digite pelo menos 2 caracteres');
                    return;
                }
                
                $.get('/usuarios/search', { searchTerm: term }, function(data) {
                    var html = '';
                    if (data.length === 0) {
                        html = '<div class="alert alert-warning">Nenhum usuário encontrado</div>';
                    } else {
                        data.forEach(function(user) {
                            html += '<div class="p-2 border rounded mb-1" style="cursor: pointer;" data-id="' + user.id + '">' + user.nomeUsuario + '</div>';
                        });
                    }
                    $('#results').html(html);

                    $('#results [data-id]').click(function() {
                        var id = $(this).data('id');
                        var name = $(this).text();
                        $('#selected').html('<div class="alert alert-success">Usuário: ' + name + '</div>');
                        $('#userId').val(id);
                        $('#results').empty();
                        checkForm();
                    });
                });
            });

            // Calcular preview
            $('input[name="valorOrcamento"], select[name="icmsEstados"]').on('input change', function() {
                var valor = parseFloat($('input[name="valorOrcamento"]').val()) || 0;
                var estado = $('select[name="icmsEstados"]').val();
                
                if (valor > 0 && estado) {
                    var taxa = estado === 'ICMS_MG' ? 0.18 : estado === 'ICMS_SP' ? 0.12 : 0.20;
                    var icms = valor * taxa;
                    var total = valor + icms;
                    
                    $('#previewContent').html(
                        '<strong>Valor:</strong> R$ ' + valor.toFixed(2) + '<br>' +
                        '<strong>ICMS:</strong> R$ ' + icms.toFixed(2) + '<br>' +
                        '<strong>Total:</strong> R$ ' + total.toFixed(2)
                    );
                    $('#preview').show();
                } else {
                    $('#preview').hide();
                }
                
                checkForm();
            });

            // Buscar clientes
            $('#searchClienteBtn').click(function() {
                var term = $('#searchClienteTerm').val().trim();
                if (term.length < 2) {
                    alert('Digite pelo menos 2 caracteres');
                    return;
                }
                
                $.get('/orcamentos/clientes/search', { searchTerm: term }, function(data) {
                    var html = '';
                    if (data.length === 0) {
                        html = '<div class="alert alert-warning">Nenhum cliente encontrado</div>';
                    } else {
                        data.forEach(function(cliente) {
                            html += '<div class="p-2 border rounded mb-1" style="cursor: pointer;" data-id="' + cliente.id + '" data-nome="' + cliente.nome + '" data-cpf="' + cliente.cpf + '">' + 
                                    '<strong>' + cliente.nome + '</strong> - CPF: ' + cliente.cpf + '</div>';
                        });
                    }
                    $('#clienteResults').html(html);

                    $('#clienteResults [data-id]').click(function() {
                        var id = $(this).data('id');
                        var nome = $(this).data('nome');
                        var cpf = $(this).data('cpf');
                        $('#clienteSelected').html('<div class="alert alert-success">Cliente: ' + nome + ' (CPF: ' + cpf + ')</div>');
                        $('#clienteId').val(id);
                        $('#clienteResults').empty();
                        checkForm();
                    });
                });
            });

            // Verificar formulário
            function checkForm() {
                var cliente = $('#clienteId').val();
                var user = $('#userId').val();
                var valor = $('input[name="valorOrcamento"]').val();
                var estado = $('select[name="icmsEstados"]').val();
                
                // Cliente é obrigatório, usuário é opcional
                $('#submitBtn').prop('disabled', !(cliente && valor && estado));
            }

            // Limpar modal
            $('#addModal').on('hidden.bs.modal', function() {
                $('#searchTerm').val('');
                $('#searchClienteTerm').val('');
                $('#results').empty();
                $('#clienteResults').empty();
                $('#selected').empty();
                $('#clienteSelected').empty();
                $('#userId').val('');
                $('#clienteId').val('');
                $('#preview').hide();
                $('#submitBtn').prop('disabled', true);
            });
        });

        function editar(id) {
            alert('Editar: ' + id);
        }

        function excluir(id) {
            if (confirm('Excluir este orçamento?')) {
                alert('Excluir: ' + id);
            }
        }
    </script>
</body>
</html>